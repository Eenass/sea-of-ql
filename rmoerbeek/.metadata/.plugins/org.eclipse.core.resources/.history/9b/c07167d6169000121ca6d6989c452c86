package org.uva.sea.ql.renderer;

import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.uva.sea.ql.ast.expression.Ident;
import org.uva.sea.ql.ast.statement.Form;
import org.uva.sea.ql.ast.types.Type;
import org.uva.sea.ql.parser.antlr.ANTLRParser;
import org.uva.sea.ql.parser.test.ParseError;
import org.uva.sea.ql.parser.typechecker.CheckStat;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;


public class MainQL extends JFrame {
	
	private String inputLoc;
	private String outputLoc;
	private String formName;
	private State state;
	
	public MainQL(String inputLoc, String outputLoc) {
		this.inputLoc = inputLoc;
		this.outputLoc = outputLoc;
		
		startUI();
		render();
	}
	
	
	private void startUI() {
		setTitle("My QL Form");
		setSize(600, 600);
		setDefaultCloseOperation(EXIT_ON_CLOSE);
		addWindowListener(new WindowAdapter() {
		    public void windowClosing(WindowEvent e) {
		       createXML(getOutputLoc());
		    }
		}
		);	
	}
	
	
	private void createXML(String outputLoc) {
		
		try {
			 
			DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();
			DocumentBuilder docBuilder = docFactory.newDocumentBuilder();
	 
			// root elements
			Document doc = docBuilder.newDocument();
			Element rootElement = doc.createElement("form");
			rootElement.setAttribute("name", getFormName());
			doc.appendChild(rootElement);
			
			
	 
			// staff elements
			Element staff = doc.createElement("question");
			rootElement.appendChild(staff);
	 
			// set attribute to staff element
			Attr attr = doc.createAttribute("id");
			attr.setValue("1");
			staff.setAttributeNode(attr);
	 
			// shorten way
			// staff.setAttribute("id", "1");
	 
			// firstname elements
			Element firstname = doc.createElement("firstname");
			firstname.appendChild(doc.createTextNode("yong"));
			staff.appendChild(firstname);
	 
			// lastname elements
			Element lastname = doc.createElement("lastname");
			lastname.appendChild(doc.createTextNode("mook kim"));
			staff.appendChild(lastname);
	 
			// nickname elements
			Element nickname = doc.createElement("nickname");
			nickname.appendChild(doc.createTextNode("mkyong"));
			staff.appendChild(nickname);
	 
			// salary elements
			Element salary = doc.createElement("salary");
			salary.appendChild(doc.createTextNode("100000"));
			staff.appendChild(salary);
	 
			// write the content into xml file
			TransformerFactory transformerFactory = TransformerFactory.newInstance();
			Transformer transformer = transformerFactory.newTransformer();
			DOMSource source = new DOMSource(doc);
			StreamResult result = new StreamResult(new File("C:\\file.xml"));
	 
			// Output to console for testing
			// StreamResult result = new StreamResult(System.out);
	 
			transformer.transform(source, result);
	 
			System.out.println("File saved!");
	 
		  } catch (ParserConfigurationException pce) {
			pce.printStackTrace();
		  } catch (TransformerException tfe) {
			tfe.printStackTrace();
		  }
	}
		
		
	
	
	private void render() {
		State state = new State();
		ANTLRParser parser = new ANTLRParser();
		ArrayList<String> errorList = new ArrayList<String>();
		
		String source = loadFile(getInputLoc());
		
		if (source != null) {
			
			try {
				Form form = parser.parseForm(source);
				setFormName(form.getId().getValue());
				
				boolean check = CheckStat.check(form, new HashMap<Ident, org.uva.sea.ql.ast.types.Type>(), errorList);
				
				if(check) {
					JPanel panel = Renderer.render(form.getBody(), state);
					setState(state);
					panel.setVisible(true);
				
					JFrame frame = new JFrame("My QL");
					//frame.setSize(400,400);
					//frame.setVisible(true);
					//frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
					frame.add(panel);
					
				} else {
					
					for(int i = 0; i<errorList.size(); i++) {
						/* pop-up box for every compilation error */
						new ErrorBox(errorList.get(i));
					}
					
				}
				
				
			} catch (ParseError e) {
			
				e.printStackTrace();
			}
		}
	}

	private String loadFile(String inputLoc) {
		ByteArrayOutputStream stream = new ByteArrayOutputStream();
		//File f = new File(inputLoc);
		String output;
		int temp;
		byte[] b;
		

		try {
			InputStream input = new FileInputStream(inputLoc);
			b = new byte[1024];
			while ((temp = input.read(b)) >= 0) {
				stream.write(b, 0, temp);
			}
			output = new String(stream.toByteArray());
		} catch (FileNotFoundException e){
			output = null;
			
		} catch (IOException e) {
			e.printStackTrace();
			output = null;
		}
		
		return output;
	}


	private String getInputLoc() {
		return this.inputLoc;
	}
	
	private String getOutputLoc() {
		return this.outputLoc;
	}
	
	private String getFormName() {
		return this.formName;
	}
	
	private void setFormName(String name) {
		this.formName = name;
	}
	
	private void setState(state) {
		this.state = state;
	}
	
	private State getState() {
		return this.state;
	}

}
